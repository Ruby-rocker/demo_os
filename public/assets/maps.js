OneStory.ResultWindow={show:function(a){(OneStory.ResultWindow.win=OneStory.ResultWindow.win||new OneStory.ResultWin("locationList")).update({subtitle:a.getTitle()})},hide:function(){var a=OneStory.ResultWindow.win;return a?a.hide():null}};
var DisplayObject=new Class({show:function(a){if(!this.div)return this;this.isVisible()||this.div.setStyles({opacity:0,display:"block"});this.div.fade(a||1);return this},hide:function(){if(!this.div)return this;this.div.fade(0);return this},toggle:function(){return this.isVisible()?this.hide():this.show()},isVisible:function(){return this.div?this.div.getStyle("display")!=="none"&&this.div.getStyle("opacity")!==0:!1}});
OneStory.ResultWin=new Class({Implements:[Options,Events,DisplayObject],options:{ids:null,title:"Location",subtitle:null,results:[]},initialize:function(a,c){this.div=$(a).set("tween",{duration:"short"});this.setOptions(c);this.setup();this.options.subtitle&&this.update().show()},setup:function(){this.div.set("tween",{duration:"150"});this.header=this.div.getFirst("div");this.content=this.div.getLast("div");this.title=this.header.getFirst("h3");this.subtitle=this.header.getFirst("h2");(this.btnClose=
this.header.getElements("a.close"))&&this.btnClose.addEvent("click",function(a){(new Event(a)).stop();this.hide()}.bind(this));return this},update:function(a){this.setOptions(a||{});var c;this.title&&this.title.set("text",this.options.title+":");$type(this.options.ids)=="array"&&(c="/stories/in/"+this.options.subtitle);this.options.subtitle&&(this.subtitle&&this.subtitle.set("text",27<this.options.subtitle.length?this.options.subtitle.replace(/\s$/,"").substring(0,27)+"...":this.options.subtitle),c=c||
"/stories/near/location/?query="+this.options.subtitle);this.content.empty().load(c);this.isVisible()||this.show();return this}});
function MarkerManager(a,c){var b=this;b.map_=a;b.mapZoom_=a.getZoom();b.projection_=a.getCurrentMapType().getProjection();c=c||{};b.tileSize_=MarkerManager.DEFAULT_TILE_SIZE_;for(var d=a.getMapTypes(),e=d[0].getMaximumResolution(),f=0;f<d.length;f++){var i=d[f].getMaximumResolution();i>e&&(e=i)}b.maxZoom_=c.maxZoom||e;b.trackMarkers_=c.trackMarkers;b.show_=c.show||!0;d=typeof c.borderPadding==="number"?c.borderPadding:MarkerManager.DEFAULT_BORDER_PADDING_;b.swPadding_=new GSize(-d,d);b.nePadding_=
new GSize(d,-d);b.borderPadding_=d;b.gridWidth_=[];b.grid_=[];b.grid_[b.maxZoom_]=[];b.numMarkers_=[];b.numMarkers_[b.maxZoom_]=0;GEvent.bind(a,"moveend",b,b.onMapMoveEnd_);b.removeOverlay_=function(c){a.removeOverlay(c);b.shownMarkers_--};b.addOverlay_=function(c){b.show_&&(a.addOverlay(c),b.shownMarkers_++)};b.resetManager_();b.shownMarkers_=0;b.shownBounds_=b.getMapGridBounds_()}MarkerManager.DEFAULT_TILE_SIZE_=1024;MarkerManager.DEFAULT_BORDER_PADDING_=100;
MarkerManager.MERCATOR_ZOOM_LEVEL_ZERO_RANGE=256;MarkerManager.prototype.resetManager_=function(){for(var a=MarkerManager.MERCATOR_ZOOM_LEVEL_ZERO_RANGE,c=0;c<=this.maxZoom_;++c)this.grid_[c]=[],this.numMarkers_[c]=0,this.gridWidth_[c]=Math.ceil(a/this.tileSize_),a<<=1};MarkerManager.prototype.clearMarkers=function(){this.processAll_(this.shownBounds_,this.removeOverlay_);this.resetManager_()};
MarkerManager.prototype.getTilePoint_=function(a,c,b){a=this.projection_.fromLatLngToPixel(a,c);return new GPoint(Math.floor((a.x+b.width)/this.tileSize_),Math.floor((a.y+b.height)/this.tileSize_))};MarkerManager.prototype.addMarkerBatch_=function(a,c,b){var d=a.getPoint();a.MarkerManager_minZoom=c;this.trackMarkers_&&GEvent.bind(a,"changed",this,this.onMarkerMoved_);for(d=this.getTilePoint_(d,b,GSize.ZERO);b>=c;b--)this.getGridCellCreate_(d.x,d.y,b).push(a),d.x>>=1,d.y>>=1};
MarkerManager.prototype.isGridPointVisible_=function(a){var c=this.shownBounds_.minY<=a.y&&a.y<=this.shownBounds_.maxY,b=this.shownBounds_.minX,d=b<=a.x&&a.x<=this.shownBounds_.maxX;!d&&b<0&&(d=this.gridWidth_[this.shownBounds_.z],d=b+d<=a.x&&a.x<=d-1);return c&&d};
MarkerManager.prototype.onMarkerMoved_=function(a,c,b){var d=this.maxZoom_,e=!1;c=this.getTilePoint_(c,d,GSize.ZERO);for(b=this.getTilePoint_(b,d,GSize.ZERO);d>=0&&(c.x!==b.x||c.y!==b.y);){var f=this.getGridCellNoCreate_(c.x,c.y,d);f&&this.removeFromArray_(f,a)&&this.getGridCellCreate_(b.x,b.y,d).push(a);d===this.mapZoom_&&(this.isGridPointVisible_(c)?this.isGridPointVisible_(b)||(this.removeOverlay_(a),e=!0):this.isGridPointVisible_(b)&&(this.addOverlay_(a),e=!0));c.x>>=1;c.y>>=1;b.x>>=1;b.y>>=1;
--d}e&&this.notifyListeners_()};MarkerManager.prototype.removeMarker=function(a){for(var c=this.maxZoom_,b=!1,d=this.getTilePoint_(a.getPoint(),c,GSize.ZERO);c>=0;){var e=this.getGridCellNoCreate_(d.x,d.y,c);e&&this.removeFromArray_(e,a);c===this.mapZoom_&&this.isGridPointVisible_(d)&&(this.removeOverlay_(a),b=!0);d.x>>=1;d.y>>=1;--c}b&&this.notifyListeners_();this.numMarkers_[a.MarkerManager_minZoom]--};
MarkerManager.prototype.addMarkers=function(a,c,b){b=this.getOptMaxZoom_(b);for(var d=a.length-1;d>=0;d--)this.addMarkerBatch_(a[d],c,b);this.numMarkers_[c]+=a.length};MarkerManager.prototype.getOptMaxZoom_=function(a){return a||this.maxZoom_};MarkerManager.prototype.getMarkerCount=function(a){for(var c=0,b=0;b<=a;b++)c+=this.numMarkers_[b];return c};
MarkerManager.prototype.getMarker=function(a,c,b){var d=new GLatLng(a,c),e=this.getTilePoint_(d,b,GSize.ZERO);d=new GMarker(d);b=this.getGridCellNoCreate_(e.x,e.y,b);if(b!=void 0)for(e=0;e<b.length;e++)a==b[e].getLatLng().lat()&&c==b[e].getLatLng().lng()&&(d=b[e]);return d};
MarkerManager.prototype.addMarker=function(a,c,b){b=this.getOptMaxZoom_(b);this.addMarkerBatch_(a,c,b);this.isGridPointVisible_(this.getTilePoint_(a.getPoint(),this.mapZoom_,GSize.ZERO))&&c<=this.shownBounds_.z&&this.shownBounds_.z<=b&&(this.addOverlay_(a),this.notifyListeners_());this.numMarkers_[c]++};GBounds.prototype.containsPoint=function(a){return this.minX<=a.x&&this.maxX>=a.x&&this.minY<=a.y&&this.maxY>=a.y};
MarkerManager.prototype.getGridCellCreate_=function(a,c,b){var d=this.grid_[b];a<0&&(a+=this.gridWidth_[b]);b=d[a];if(!b)return b=d[a]=[],b[c]=[];a=b[c];if(!a)return b[c]=[];return a};MarkerManager.prototype.getGridCellNoCreate_=function(a,c,b){var d=this.grid_[b];a<0&&(a+=this.gridWidth_[b]);return(a=d[a])?a[c]:void 0};
MarkerManager.prototype.getGridBounds_=function(a,c,b,d){c=Math.min(c,this.maxZoom_);var e=a.getSouthWest();a=a.getNorthEast();b=this.getTilePoint_(e,c,b);d=this.getTilePoint_(a,c,d);var f=this.gridWidth_[c];if(a.lng()<e.lng()||d.x<b.x)b.x-=f;if(d.x-b.x+1>=f)b.x=0,d.x=f-1;e=new GBounds([b,d]);e.z=c;return e};MarkerManager.prototype.getMapGridBounds_=function(){return this.getGridBounds_(this.map_.getBounds(),this.mapZoom_,this.swPadding_,this.nePadding_)};
MarkerManager.prototype.onMapMoveEnd_=function(){this.objectSetTimeout_(this,this.updateMarkers_,0)};MarkerManager.prototype.objectSetTimeout_=function(a,c,b){return window.setTimeout(function(){c.call(a)},b)};MarkerManager.prototype.visible=function(){return this.show_?!0:!1};MarkerManager.prototype.isHidden=function(){return!this.show_};MarkerManager.prototype.show=function(){this.show_=!0;this.refresh()};MarkerManager.prototype.hide=function(){this.show_=!1;this.refresh()};
MarkerManager.prototype.toggle=function(){this.show_=!this.show_;this.refresh()};MarkerManager.prototype.refresh=function(){this.shownMarkers_>0&&this.processAll_(this.shownBounds_,this.removeOverlay_);this.show_&&this.processAll_(this.shownBounds_,this.addOverlay_);this.notifyListeners_()};
MarkerManager.prototype.updateMarkers_=function(){this.mapZoom_=this.map_.getZoom();var a=this.getMapGridBounds_();if(!(a.equals(this.shownBounds_)&&a.z===this.shownBounds_.z))a.z!==this.shownBounds_.z?(this.processAll_(this.shownBounds_,this.removeOverlay_),this.show_&&this.processAll_(a,this.addOverlay_)):(this.rectangleDiff_(this.shownBounds_,a,this.removeCellMarkers_),this.show_&&this.rectangleDiff_(a,this.shownBounds_,this.addCellMarkers_)),this.shownBounds_=a,this.notifyListeners_()};
MarkerManager.prototype.notifyListeners_=function(){GEvent.trigger(this,"changed",this.shownBounds_,this.shownMarkers_)};MarkerManager.prototype.processAll_=function(a,c){for(var b=a.minX;b<=a.maxX;b++)for(var d=a.minY;d<=a.maxY;d++)this.processCellMarkers_(b,d,a.z,c)};MarkerManager.prototype.processCellMarkers_=function(a,c,b,d){if(a=this.getGridCellNoCreate_(a,c,b))for(c=a.length-1;c>=0;c--)d(a[c])};MarkerManager.prototype.removeCellMarkers_=function(a,c,b){this.processCellMarkers_(a,c,b,this.removeOverlay_)};
MarkerManager.prototype.addCellMarkers_=function(a,c,b){this.processCellMarkers_(a,c,b,this.addOverlay_)};MarkerManager.prototype.rectangleDiff_=function(a,c,b){var d=this;d.rectangleDiffCoords_(a,c,function(c,f){b.apply(d,[c,f,a.z])})};
MarkerManager.prototype.rectangleDiffCoords_=function(a,c,b){var d=a.minX,e=a.minY,f=a.maxX;a=a.maxY;var i=c.minX,j=c.minY,k=c.maxX;c=c.maxY;var h,g;for(h=d;h<=f;h++){for(g=e;g<=a&&g<j;g++)b(h,g);for(g=Math.max(c+1,e);g<=a;g++)b(h,g)}for(g=Math.max(e,j);g<=Math.min(a,c);g++){for(h=Math.min(f+1,i)-1;h>=d;h--)b(h,g);for(h=Math.max(d,k+1);h<=f;h++)b(h,g)}};MarkerManager.prototype.removeFromArray_=function(a,c,b){for(var d=0,e=0;e<a.length;++e)if(a[e]===c||b&&a[e]===c)a.splice(e--,1),d++;return d};
